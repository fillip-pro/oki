stages:
    - build
    - test

variables:
  GIT_SUBMODULE_STRATEGY: recursive

build:linux:
    image: golang:1.10
    stage: build
    before_script:
        # install ssh-agent
        - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'

        # run ssh-agent
        - eval $(ssh-agent -s)

        # add ssh key stored in SSH_PRIVATE_KEY variable to the agent store
        - ssh-add <(echo "$SSH_PRIVATE_KEY")

        # disable host key checking (NOTE: makes you susceptible to man-in-the-middle attacks)
        # WARNING: use only in docker container, if you use it with shell you will overwrite your user's ssh config
        - mkdir -p ~/.ssh
        - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
        - go get github.com/tools/godep
        - ln -s /builds /go/src/gitlab.com
        - cd /go/src/gitlab.com/fillip/oki
    script:
        # Add here all the dependencies, or use glide/govendor/...
        # to get them automatically.
        #- go get github.com/alecthomas/kingpin
        # Better put this in a Makefile
        - make
    artifacts:
        paths:
            - oki

test-binary:
    stage: test
    script:
        - make test

#format:
#    stage: test
#    script:
        #- go get github.com/alecthomas/kingpin
#        - go tool vet -composites=false -shadow=true *.go
#        - go test -race $(go list ./... | grep -v /vendor/)